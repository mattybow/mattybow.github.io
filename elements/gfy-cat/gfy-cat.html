<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/core-ajax/core-ajax.html">
<link rel="import" href="/elements/playpause-svg/playpause-svg.html">
<polymer-element name="gfy-cat" attributes="src gfyName width color fill strokeWidth ntimes">
	<template>
		<link rel="stylesheet" href="gfy-cat.css">
        <template if="{{src}}">
            <core-ajax url="http://upload.gfycat.com/transcode?fetchUrl={{src | cleanSrcUrl}}" id="gfyAjax" handleAs="json"></core-ajax>
        </template>
        <div id="gfyContainer" on-mouseup="{{toggleState}}" on-mouseover="{{hoverHandle}}" on-mouseout="{{hoverOutHandle}}">
            <video autoplay loop width="{{ width }}" id="vid" src="//zippy.gfycat.com/{{gfyName}}{{ext}}"></video>
            <video autoplay loop hidden width="{{ width }}" id="vidReverse" src="//zippy.gfycat.com/{{gfyName}}-reverse{{ext}}"></video>
            <div class="clearfix"></div>
            <playpause-svg stroke="{{color}}" class="{{visibility}}" strokeWidth="{{fill ? 0:strokeWidth*.5}}" fill="{{fill ? color:'transparent'}}" id="playPauseSvg"></playpause-svg>
            <div class="gfyCtrl {{visibility}}" id="gfyCtrlBox" style="-webkit-flex-flow: column nowrap; flex-flow:column nowrap; -webkit-justify-content:space-around; justify-content:space-around;">

                <div class="speedCtrl">
                    <div class="bttn" id="up" on-mouseup="{{increaseSpeed}}" title="accelerate playback">
                        <svg version="1.1" id="speedUp" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 60 60" enable-background="new 0 0 60 60" xml:space="preserve" preserveAspectRatio="meet" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linecap:round;stroke-miterlimit:1.41421;">
                            <g>
                                <g>
                                    <path fill="{{fill ? color:'transparent'}}" d="M54.368,30L26.3873,49.5821L26.3873,10.4179L54.368,30Z" stroke-width="{{fill ? 0:strokeWidth}}" stroke="{{color}}"/>
                                </g>
                                <g>
                                    <path fill="{{fill ? color:'transparent'}}" d="M23.866,30L5.63198,42.7609L5.63198,17.2391L23.866,30Z" stroke-width="{{fill ? 0:strokeWidth}}" stroke="{{color}}"/>
                                </g>
                            </g>
                        </svg>
                    </div>
                    <div id="speed" _style="color:{{color}}">{{speed}}x</div>
                    <div class="bttn" id="down" on-mouseup="{{decreaseSpeed}}" title="slow playback">
                        <svg version="1.1" id="speedDown" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 60 60" enable-background="new 0 0 60 60" xml:space="preserve" preserveAspectRatio="meet" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linecap:round;stroke-miterlimit:1.41421;"> 
                            <g>
                                <g>
                                    <path fill="{{fill ? color:'transparent'}}" d="M5.63198,30L33.6127,10.4179L33.6127,49.5821L5.63198,30Z" stroke-width="{{fill ? 0:strokeWidth}}" stroke="{{color}}"/>
                                </g>
                                <g>
                                    <path fill="{{fill ? color:'transparent'}}" d="M36.134,29.5376L54.368,16.7767L54.368,42.2985L36.134,29.5376Z" stroke-width="{{fill ? 0:strokeWidth}}" stroke="{{color}}"/>
                                </g>
                            </g>
                        </svg>
                    </div>
                </div>
                <div class="bttn" id="pingpong" on-mouseup="{{togglePingPong}}" title="pingpong playback">
                    <svg version="1.1" id="speedDown" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 60 60" enable-background="new 0 0 60 60" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linecap:round;stroke-miterlimit:1.41421;"> 
                        <g>
                            <g>
                                <path fill="{{fill ? color:'transparent'}}" d="M48,30L2.14719,57.7786L2.14719,2.22145L48,30Z" stroke-width="{{fill ? 0:strokeWidth}}" stroke="{{color}}"/>
                            </g>
                            <g>
                                <path fill="{{fill ? color:'transparent'}}" d="M12,30L57.8528,2.22145L57.8528,57.7786L12,30Z" stroke-width="{{fill ? 0:strokeWidth}}" stroke="{{color}}"/>
                            </g>
                        </g>
                    </svg>
                </div>

                <div class="bttn" id="reverse" on-mouseup="{{reversePlayback}}" title="reverse playback">
                    <svg version="1.1" id="speedDown" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 60 60" enable-background="new 0 0 60 60" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linecap:round;stroke-miterlimit:1.41421;"> 
                        <g>
                            <g>
                                <path fill="{{fill ? color:'transparent'}}" d="M9.44958,30L50.5504,4.44605L50.5504,55.5539L9.44958,30Z" stroke-width="{{fill ? 0:strokeWidth}}" stroke="{{color}}"/>
                            </g>
                        </g>
                    </svg>
                </div>
                
            </div>
            <content></content>
        </div>
	</template>
	<script>
		Polymer('gfy-cat', {
            created:function(){
                this.gfyName="";
                this.width="";
                this.speed=1;
                this.color="#eee";
                this.visibility="hidden";
                this.fill=false;
                this.strokeWidth=3;
                this.playMode='forward';
                this.pingPongActive=false;
                this.src='';
                this.getExt();
                this.state='play';
                this.playCount=0;
                this.ntimes=3;
            },
            ready:function(){
                this.$.vid.addEventListener('play',function(){
                    this.startCounting();
                }.bind(this));
                this.$.vidReverse.addEventListener('play',function(){
                    this.startCounting();
                }.bind(this));
                this.$.vid.addEventListener('ended',function(){
                    console.log('forward ended');
                    this.reversePlayback();
                }.bind(this));
                this.$.vidReverse.addEventListener('ended',function(){
                    console.log('reverse ended');
                    this.reversePlayback();
                }.bind(this));
                if(this.src && !this.src.match(/\.gifv/)){                                           //if src defined, fetch converted gfyName
                    this.$.gfyAjax.addEventListener("core-response", function(e) {
                            this.gfyName=e.detail.response.gfyName;
                            //this.$.vid.src="http://zippy.gfycat.com/"+this.gfyName+".mp4";
                            //this.$.vidReverse.src="http://zippy.gfycat.com/"+this.gfyName+"-reverse.mp4";
                        }.bind(this));
                    this.$.gfyAjax.go();
                }
            },
            incrementPlayCount:function(){
                this.playCount++;
                if(this.playCount===this.ntimes || this.interrupt){
                    this.pauseVid();
                    if(this.interrupt){
                        this.interrupt = false;
                        this.playVid();
                    }
                }
            },
            resetPlayCount:function(){
                this.playCount=0;
                if(this.intervalId){
                    clearInterval(this.intervalId);
                    this.intervalId=undefined;
                }
            },
            startCounting:function(){
                console.log(this.intervalId);
                if(!this.intervalId){
                    console.log('starting to count');
                    var ppMultiplier = 1;
                    if(this.pingPongActive){                                        //backward and forward will count as 1
                        ppMultiplier=2;
                        console.log(ppMultiplier);
                    }
                    var interval = this.$.vid.duration*(1/this.speed)*ppMultiplier*1000;
                    console.log(interval);
                    this.intervalId = setInterval(this.incrementPlayCount.bind(this),interval);
                }
            },
            getExt:function(){
                var testVid = document.createElement('video');
                switch (true){
                    case testVid.canPlayType('video/mp4')!="":
                        this.ext='.mp4';
                        break;
                    case testVid.canPlayType('video/webm')!="":
                        this.ext='.webm';
                        break;
                }
            },
            cleanSrcUrl:function(url){
                return url.replace(/http:\/\//,'');
            },
            showCtrls:function(e,d,s){
                this.visibility='shown';
                if(this.hideTimeOut){
                    clearTimeout(this.hideTimeOut);
                }
                this.hideTimeOut=setTimeout(this.hideCtrls.bind(this),3000);
            },
            hideCtrls:function(){
                this.visibility='hidden';
                this.hideTimeOut=undefined;
            },
            hoverHandle:function(e,d,s){
                if(!this.isMobile()){
                    if(!this.hideTimeOut){
                        this.showCtrls();
                    }  
                    clearTimeout(this.hideTimeOut);                 //let the mouseout event hide the ctrls
                }
            },
            isMobile:function(){
                return (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));
            },
            hoverOutHandle:function(){
                if(this.hideTimeOut){
                    clearTimeout(this.hideTimeOut);
                }
                this.hideTimeOut=setTimeout(this.hideCtrls.bind(this),400);
            },
            mobileCtrlReset:function(){
                if(this.isMobile()){
                    this.showCtrls();
                }
            },
            autoResume:function(){
                if(this.state==='pause'){
                    this.playVid();
                } else {
                    this.interrupt = true;
                }
            },
            increaseSpeed:function(e,d,s){
                e.stopPropagation();
                this.mobileCtrlReset();
                if(this.speed<1){
                    this.speed *= 2;
                } else {
                    this.speed += .5;
                }
                this.$.vid.playbackRate=this.speed;
                this.$.vidReverse.playbackRate=this.speed;
                this.autoResume();
            },
            decreaseSpeed:function(e,d,s){
                e.stopPropagation();
                this.mobileCtrlReset();
                if(this.speed<1){
                    this.speed /= 2;
                } else {
                    this.speed -= .5;
                }
                this.$.vid.playbackRate=this.speed;
                this.$.vidReverse.playbackRate=this.speed;
                this.autoResume();
            },
            reversePlayback:function(e,d,s){
                console.log('reverse method called');
                if(e) {
                    e.stopPropagation();
                    this.mobileCtrlReset();
                    this.resetPlayCount();
                    this.checkState();
                    if(this.pingPongActive){
                        this.deactivatePingPong();
                    }
                }
                
                if(this.playMode === 'reverse'){
                    this.$.vidReverse.pause();
                    this.$.vidReverse.setAttribute('hidden',"true");
                    this.$.vid.removeAttribute('hidden');
                    this.$.vid.currentTime=0;
                    this.$.vid.play();
                    this.playMode = 'forward';
                    console.log('play forward');
                } else {
                    this.$.vid.pause();
                    this.$.vid.setAttribute('hidden',"true");
                    this.$.vidReverse.removeAttribute('hidden');
                    this.$.vidReverse.currentTime=0;
                    this.$.vidReverse.play();
                    this.playMode = 'reverse';
                    console.log('play backward');
                }
                
            },
            checkState:function(){
                if(this.state==='pause') this.state='play';
            },
            togglePingPong:function(e,d,s){
                e.stopPropagation();
                this.mobileCtrlReset();
                if(this.pingPongActive){
                    this.deactivatePingPong();
                } else {
                    this.activatePingPong();
                }
            },
            activatePingPong:function(){
                this.pingPongActive=true;
                this.$.vid.removeAttribute('loop');
                this.$.vidReverse.removeAttribute('loop');
                this.playVid();
                this.checkState();
            },
            deactivatePingPong:function(){
                this.$.vid.setAttribute('loop','true');         //when video is looping, 'ended' event does not trigger
                this.$.vidReverse.setAttribute('loop','true');
                this.pingPongActive=false;
            },
            playVid:function(){
                this.resetPlayCount();
                this.$.vid.play();
                this.$.vidReverse.play();
                this.state='play';
            },
            pauseVid:function(){
                this.resetPlayCount();
                this.$.vid.pause();
                this.$.vidReverse.pause();
                this.state='pause';
            },
            stateChanged:function(attrName, oldVal, newVal){
                this.triggerToggleEvent();
            },
            toggleState:function(e,d,s){
                if(!this.hideTimeOut) this.showCtrls();                //for mobile case
                if(this.state==='play' || this.state === undefined){
                    this.pauseVid();
                } else if (this.state ==='pause') {
                    this.playVid();
                }
              //this.triggerToggleEvent();
            },
            triggerToggleEvent:function(){
                var that = this;
                [].forEach.call(this.shadowRoot.querySelectorAll('playpause-svg'),function(el,i){
                    el.fire('togglePlay',{state:that.state});
                }); 
            }

		});
	</script>
</polymer-element>