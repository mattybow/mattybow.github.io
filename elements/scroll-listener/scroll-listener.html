<link rel="import" href="../../bower_components/polymer/polymer.html">
<polymer-element name="scroll-listener" attributes="">
	<template>
		<style>
			:host {
				display: none;
			}
		</style>
	</template>
	<script>
		Polymer('scroll-listener', {
			domReady:function(){
				var scroller = document.getElementsByClassName('parallax')[0] || window;
				this.labels = document.getElementsByTagName('flip-label');
				if(scroller){
					this.setScrollListener(scroller,'scroll',this.labelHandler.bind(this));
				}
			},
			labelHandler:function(){
				var unflipped = this.getUnflipped();
				if(unflipped.length){
					var viewHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
					var threshold = viewHeight*0.75;
					var timeOffset = 100 * unflipped.length + 1;
					var prevPos;
					[].forEach.call(unflipped,function(label){
						var labelPos = label.getBoundingClientRect().top;
						if(labelPos <= threshold){
							if (labelPos===prevPos || prevPos === undefined){
								setTimeout(function(){
									label.flipShow();
								}.bind(this),timeOffset);
								timeOffset-=100;
								prevPos=labelPos;
							} else {
								label.flipShow();
							}
						}
					});
				}
			},
			getUnflipped:function(){
				var output = [];
				[].forEach.call(this.labels,function(label){
					if(!label.flipped){
						output.push(label);
					}
				});
				return output;
			},
			setScrollListener:function(target,event,callback){
				target.addEventListener(event,callback);
			}

		});
	</script>
</polymer-element>